function cov_1lojzrnngw(){var path="/home/bamberg/sd-014-c-store-manager/services/salesService.js";var hash="9fb5c14ce9c425f96ec928b09e5bdece12a4552c";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/bamberg/sd-014-c-store-manager/services/salesService.js",statementMap:{"0":{start:{line:1,column:19},end:{line:1,column:50}},"1":{start:{line:2,column:22},end:{line:2,column:56}},"2":{start:{line:4,column:22},end:{line:4,column:51}},"3":{start:{line:5,column:20},end:{line:5,column:47}},"4":{start:{line:7,column:17},end:{line:7,column:45}},"5":{start:{line:9,column:15},end:{line:12,column:1}},"6":{start:{line:10,column:16},end:{line:10,column:41}},"7":{start:{line:11,column:2},end:{line:11,column:15}},"8":{start:{line:14,column:16},end:{line:19,column:1}},"9":{start:{line:15,column:15},end:{line:15,column:47}},"10":{start:{line:16,column:2},end:{line:16,column:72}},"11":{start:{line:16,column:24},end:{line:16,column:72}},"12":{start:{line:18,column:2},end:{line:18,column:14}},"13":{start:{line:21,column:21},end:{line:29,column:1}},"14":{start:{line:22,column:16},end:{line:22,column:28}},"15":{start:{line:23,column:52},end:{line:23,column:56}},"16":{start:{line:25,column:37},end:{line:26,column:23}},"17":{start:{line:28,column:2},end:{line:28,column:54}},"18":{start:{line:28,column:30},end:{line:28,column:54}},"19":{start:{line:31,column:15},end:{line:48,column:1}},"20":{start:{line:32,column:2},end:{line:34,column:6}},"21":{start:{line:33,column:4},end:{line:33,column:29}},"22":{start:{line:36,column:17},end:{line:36,column:42}},"23":{start:{line:38,column:2},end:{line:42,column:6}},"24":{start:{line:39,column:18},end:{line:39,column:30}},"25":{start:{line:40,column:45},end:{line:40,column:49}},"26":{start:{line:41,column:4},end:{line:41,column:55}},"27":{start:{line:44,column:2},end:{line:47,column:4}},"28":{start:{line:50,column:15},end:{line:64,column:1}},"29":{start:{line:51,column:15},end:{line:51,column:47}},"30":{start:{line:52,column:2},end:{line:52,column:72}},"31":{start:{line:52,column:24},end:{line:52,column:72}},"32":{start:{line:54,column:2},end:{line:58,column:6}},"33":{start:{line:55,column:18},end:{line:55,column:30}},"34":{start:{line:56,column:58},end:{line:56,column:69}},"35":{start:{line:57,column:4},end:{line:57,column:60}},"36":{start:{line:60,column:2},end:{line:63,column:4}},"37":{start:{line:66,column:15},end:{line:73,column:1}},"38":{start:{line:67,column:15},end:{line:67,column:47}},"39":{start:{line:68,column:2},end:{line:68,column:72}},"40":{start:{line:68,column:24},end:{line:68,column:72}},"41":{start:{line:70,column:2},end:{line:70,column:34}},"42":{start:{line:72,column:2},end:{line:72,column:14}},"43":{start:{line:75,column:0},end:{line:82,column:2}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:9,column:15},end:{line:9,column:16}},loc:{start:{line:9,column:27},end:{line:12,column:1}},line:9},"1":{name:"(anonymous_1)",decl:{start:{line:14,column:16},end:{line:14,column:17}},loc:{start:{line:14,column:34},end:{line:19,column:1}},line:14},"2":{name:"(anonymous_2)",decl:{start:{line:21,column:21},end:{line:21,column:22}},loc:{start:{line:21,column:37},end:{line:29,column:1}},line:21},"3":{name:"(anonymous_3)",decl:{start:{line:31,column:15},end:{line:31,column:16}},loc:{start:{line:31,column:32},end:{line:48,column:1}},line:31},"4":{name:"(anonymous_4)",decl:{start:{line:32,column:30},end:{line:32,column:31}},loc:{start:{line:32,column:46},end:{line:34,column:3}},line:32},"5":{name:"(anonymous_5)",decl:{start:{line:38,column:30},end:{line:38,column:31}},loc:{start:{line:38,column:46},end:{line:42,column:3}},line:38},"6":{name:"(anonymous_6)",decl:{start:{line:50,column:15},end:{line:50,column:16}},loc:{start:{line:50,column:47},end:{line:64,column:1}},line:50},"7":{name:"(anonymous_7)",decl:{start:{line:54,column:37},end:{line:54,column:38}},loc:{start:{line:54,column:60},end:{line:58,column:3}},line:54},"8":{name:"(anonymous_8)",decl:{start:{line:66,column:15},end:{line:66,column:16}},loc:{start:{line:66,column:33},end:{line:73,column:1}},line:66}},branchMap:{"0":{loc:{start:{line:16,column:2},end:{line:16,column:72}},type:"if",locations:[{start:{line:16,column:2},end:{line:16,column:72}},{start:{line:16,column:2},end:{line:16,column:72}}],line:16},"1":{loc:{start:{line:28,column:2},end:{line:28,column:54}},type:"if",locations:[{start:{line:28,column:2},end:{line:28,column:54}},{start:{line:28,column:2},end:{line:28,column:54}}],line:28},"2":{loc:{start:{line:52,column:2},end:{line:52,column:72}},type:"if",locations:[{start:{line:52,column:2},end:{line:52,column:72}},{start:{line:52,column:2},end:{line:52,column:72}}],line:52},"3":{loc:{start:{line:68,column:2},end:{line:68,column:72}},type:"if",locations:[{start:{line:68,column:2},end:{line:68,column:72}},{start:{line:68,column:2},end:{line:68,column:72}}],line:68}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"9fb5c14ce9c425f96ec928b09e5bdece12a4552c"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_1lojzrnngw=function(){return actualCoverage;};}return actualCoverage;}cov_1lojzrnngw();const salesModel=(cov_1lojzrnngw().s[0]++,require('../models/salesModel'));const productsModel=(cov_1lojzrnngw().s[1]++,require('../models/productsModel'));const NotFoundError=(cov_1lojzrnngw().s[2]++,require('../errors/notFound'));const AmountError=(cov_1lojzrnngw().s[3]++,require('../errors/amount'));const messages=(cov_1lojzrnngw().s[4]++,require('../utils/messages'));cov_1lojzrnngw().s[5]++;const getAll=async()=>{cov_1lojzrnngw().f[0]++;const sales=(cov_1lojzrnngw().s[6]++,await salesModel.getAll());cov_1lojzrnngw().s[7]++;return sales;};cov_1lojzrnngw().s[8]++;const getById=async saleId=>{cov_1lojzrnngw().f[1]++;const sale=(cov_1lojzrnngw().s[9]++,await salesModel.getById(saleId));cov_1lojzrnngw().s[10]++;if(sale.length<=0){cov_1lojzrnngw().b[0][0]++;cov_1lojzrnngw().s[11]++;throw new NotFoundError(messages.sale.notFound);}else{cov_1lojzrnngw().b[0][1]++;}cov_1lojzrnngw().s[12]++;return sale;};cov_1lojzrnngw().s[13]++;const validateSale=async item=>{cov_1lojzrnngw().f[2]++;const idKey=(cov_1lojzrnngw().s[14]++,'product_id');// keep snake_case
const{[idKey]:productId,quantity:saleQty}=(cov_1lojzrnngw().s[15]++,item);const{quantity:availableQty}=(cov_1lojzrnngw().s[16]++,await productsModel.getById(productId));cov_1lojzrnngw().s[17]++;if(availableQty<saleQty){cov_1lojzrnngw().b[1][0]++;cov_1lojzrnngw().s[18]++;throw new AmountError();}else{cov_1lojzrnngw().b[1][1]++;}};cov_1lojzrnngw().s[19]++;const create=async items=>{cov_1lojzrnngw().f[3]++;cov_1lojzrnngw().s[20]++;await Promise.all(items.map(async item=>{cov_1lojzrnngw().f[4]++;cov_1lojzrnngw().s[21]++;await validateSale(item);}));const saleId=(cov_1lojzrnngw().s[22]++,await salesModel.create());cov_1lojzrnngw().s[23]++;await Promise.all(items.map(async item=>{cov_1lojzrnngw().f[5]++;const idKey=(cov_1lojzrnngw().s[24]++,'product_id');// keep snake_case
const{[idKey]:productId,quantity}=(cov_1lojzrnngw().s[25]++,item);cov_1lojzrnngw().s[26]++;await salesModel.sell(saleId,productId,quantity);}));cov_1lojzrnngw().s[27]++;return{id:saleId,itemsSold:items};};cov_1lojzrnngw().s[28]++;const update=async(saleId,updatedItems)=>{cov_1lojzrnngw().f[6]++;const sale=(cov_1lojzrnngw().s[29]++,await salesModel.getById(saleId));cov_1lojzrnngw().s[30]++;if(sale.length<=0){cov_1lojzrnngw().b[2][0]++;cov_1lojzrnngw().s[31]++;throw new NotFoundError(messages.sale.notFound);}else{cov_1lojzrnngw().b[2][1]++;}cov_1lojzrnngw().s[32]++;await Promise.all(updatedItems.map(async updatedItem=>{cov_1lojzrnngw().f[7]++;const idKey=(cov_1lojzrnngw().s[33]++,'product_id');// keep snake_case
const{[idKey]:productId,quantity:newQuantity}=(cov_1lojzrnngw().s[34]++,updatedItem);cov_1lojzrnngw().s[35]++;await salesModel.update(saleId,productId,newQuantity);}));cov_1lojzrnngw().s[36]++;return{saleId,itemUpdated:updatedItems};};cov_1lojzrnngw().s[37]++;const remove=async saleId=>{cov_1lojzrnngw().f[8]++;const sale=(cov_1lojzrnngw().s[38]++,await salesModel.getById(saleId));cov_1lojzrnngw().s[39]++;if(sale.length<=0){cov_1lojzrnngw().b[3][0]++;cov_1lojzrnngw().s[40]++;throw new NotFoundError(messages.sale.notFound);}else{cov_1lojzrnngw().b[3][1]++;}cov_1lojzrnngw().s[41]++;await salesModel.remove(saleId);cov_1lojzrnngw().s[42]++;return sale;};cov_1lojzrnngw().s[43]++;module.exports={getAll,getById,validateSale,create,update,remove};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNhbGVzU2VydmljZS5qcyJdLCJuYW1lcyI6WyJzYWxlc01vZGVsIiwicmVxdWlyZSIsInByb2R1Y3RzTW9kZWwiLCJOb3RGb3VuZEVycm9yIiwiQW1vdW50RXJyb3IiLCJtZXNzYWdlcyIsImdldEFsbCIsInNhbGVzIiwiZ2V0QnlJZCIsInNhbGVJZCIsInNhbGUiLCJsZW5ndGgiLCJub3RGb3VuZCIsInZhbGlkYXRlU2FsZSIsIml0ZW0iLCJpZEtleSIsInByb2R1Y3RJZCIsInF1YW50aXR5Iiwic2FsZVF0eSIsImF2YWlsYWJsZVF0eSIsImNyZWF0ZSIsIml0ZW1zIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsInNlbGwiLCJpZCIsIml0ZW1zU29sZCIsInVwZGF0ZSIsInVwZGF0ZWRJdGVtcyIsInVwZGF0ZWRJdGVtIiwibmV3UXVhbnRpdHkiLCJpdGVtVXBkYXRlZCIsInJlbW92ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJpN0tBZVk7MkZBZlosS0FBTUEsQ0FBQUEsVUFBVSwwQkFBR0MsT0FBTyxDQUFDLHNCQUFELENBQVYsQ0FBaEIsQ0FDQSxLQUFNQyxDQUFBQSxhQUFhLDBCQUFHRCxPQUFPLENBQUMseUJBQUQsQ0FBVixDQUFuQixDQUVBLEtBQU1FLENBQUFBLGFBQWEsMEJBQUdGLE9BQU8sQ0FBQyxvQkFBRCxDQUFWLENBQW5CLENBQ0EsS0FBTUcsQ0FBQUEsV0FBVywwQkFBR0gsT0FBTyxDQUFDLGtCQUFELENBQVYsQ0FBakIsQ0FFQSxLQUFNSSxDQUFBQSxRQUFRLDBCQUFHSixPQUFPLENBQUMsbUJBQUQsQ0FBVixDQUFkLEMsd0JBRUEsS0FBTUssQ0FBQUEsTUFBTSxDQUFHLFNBQVkseUJBQ3pCLEtBQU1DLENBQUFBLEtBQUssMEJBQUcsS0FBTVAsQ0FBQUEsVUFBVSxDQUFDTSxNQUFYLEVBQVQsQ0FBWCxDQUR5Qix3QkFFekIsTUFBT0MsQ0FBQUEsS0FBUCxDQUNELENBSEQsQyx3QkFLQSxLQUFNQyxDQUFBQSxPQUFPLENB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LHlCQUd4RCxLQUFNOUIsQ0FBQUEsVUFBVSxDQUFDNEIsTUFBWCxDQUFrQm5CLE1BQWxCLENBQTBCTyxTQUExQixDQUFxQ2UsV0FBckMsQ0FBTixDQUNELENBSmlCLENBQVosQ0FBTixDQUo2Qyx5QkFVN0MsTUFBTyxDQUNMdEIsTUFESyxDQUVMdUIsV0FBVyxDQUFFSCxZQUZSLENBQVAsQ0FJRCxDQWRELEMseUJBZ0JBLEtBQU1JLENBQUFBLE1BQU0sQ0FBRyxLQUFPeEIsQ0FBQUEsTUFBUCxFQUFrQix5QkFDL0IsS0FBTUMsQ0FBQUEsSUFBSSwyQkFBRyxLQUFNVixDQUFBQSxVQUFVLENBQUNRLE9BQVgsQ0FBbUJDLE1BQW5CLENBQVQsQ0FBVixDQUQrQix5QkFFL0IsR0FBSUMsSUFBSSxDQUFDQyxNQUFMLEVBQWUsQ0FBbkIsQ0FBc0IsMERBQU0sSUFBSVIsQ0FBQUEsYUFBSixDQUFrQkUsUUFBUSxDQUFDSyxJQUFULENBQWNFLFFBQWhDLENBQU4sQ0FBZ0QsQ0FBdEUsaUNBRitCLHlCQUkvQixLQUFNWixDQUFBQSxVQUFVLENBQUNpQyxNQUFYLENBQWtCeEIsTUFBbEIsQ0FBTixDQUorQix5QkFNL0IsTUFBT0MsQ0FBQUEsSUFBUCxDQUNELENBUEQsQyx5QkFTQXdCLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixDQUNmN0IsTUFEZSxDQUVmRSxPQUZlLENBR2ZLLFlBSGUsQ0FJZk8sTUFKZSxDQUtmUSxNQUxlLENBTWZLLE1BTmUsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBzYWxlc01vZGVsID0gcmVxdWlyZSgnLi4vbW9kZWxzL3NhbGVzTW9kZWwnKTtcbmNvbnN0IHByb2R1Y3RzTW9kZWwgPSByZXF1aXJlKCcuLi9tb2RlbHMvcHJvZHVjdHNNb2RlbCcpO1xuXG5jb25zdCBOb3RGb3VuZEVycm9yID0gcmVxdWlyZSgnLi4vZXJyb3JzL25vdEZvdW5kJyk7XG5jb25zdCBBbW91bnRFcnJvciA9IHJlcXVpcmUoJy4uL2Vycm9ycy9hbW91bnQnKTtcblxuY29uc3QgbWVzc2FnZXMgPSByZXF1aXJlKCcuLi91dGlscy9tZXNzYWdlcycpO1xuXG5jb25zdCBnZXRBbGwgPSBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IHNhbGVzID0gYXdhaXQgc2FsZXNNb2RlbC5nZXRBbGwoKTtcbiAgcmV0dXJuIHNhbGVzO1xufTtcblxuY29uc3QgZ2V0QnlJZCA9IGFzeW5jIChzYWxlSWQpID0+IHtcbiAgY29uc3Qgc2FsZSA9IGF3YWl0IHNhbGVzTW9kZWwuZ2V0QnlJZChzYWxlSWQpO1xuICBpZiAoc2FsZS5sZW5ndGggPD0gMCkgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IobWVzc2FnZXMuc2FsZS5ub3RGb3VuZCk7XG5cbiAgcmV0dXJuIHNhbGU7XG59O1xuXG5jb25zdCB2YWxpZGF0ZVNhbGUgPSBhc3luYyAoaXRlbSkgPT4ge1xuICBjb25zdCBpZEtleSA9ICdwcm9kdWN0X2lkJzsgLy8ga2VlcCBzbmFrZV9jYXNlXG4gIGNvbnN0IHsgW2lkS2V5XTogcHJvZHVjdElkLCBxdWFudGl0eTogc2FsZVF0eSB9ID0gaXRlbTtcblxuICBjb25zdCB7IHF1YW50aXR5OiBhdmFpbGFibGVRdHkgfSA9IGF3YWl0IHByb2R1Y3RzTW9kZWxcbiAgICAuZ2V0QnlJZChwcm9kdWN0SWQpO1xuXG4gIGlmIChhdmFpbGFibGVRdHkgPCBzYWxlUXR5KSB0aHJvdyBuZXcgQW1vdW50RXJyb3IoKTtcbn07XG5cbmNvbnN0IGNyZWF0ZSA9IGFzeW5jIChpdGVtcykgPT4ge1xuICBhd2FpdCBQcm9taXNlLmFsbChpdGVtcy5tYXAoYXN5bmMgKGl0ZW0pID0+IHtcbiAgICBhd2FpdCB2YWxpZGF0ZVNhbGUoaXRlbSk7XG4gIH0pKTtcblxuICBjb25zdCBzYWxlSWQgPSBhd2FpdCBzYWxlc01vZGVsLmNyZWF0ZSgpO1xuXG4gIGF3YWl0IFByb21pc2UuYWxsKGl0ZW1zLm1hcChhc3luYyAoaXRlbSkgPT4ge1xuICAgIGNvbnN0IGlkS2V5ID0gJ3Byb2R1Y3RfaWQnOyAvLyBrZWVwIHNuYWtlX2Nhc2VcbiAgICBjb25zdCB7IFtpZEtleV06IHByb2R1Y3RJZCwgcXVhbnRpdHkgfSA9IGl0ZW07XG4gICAgYXdhaXQgc2FsZXNNb2RlbC5zZWxsKHNhbGVJZCwgcHJvZHVjdElkLCBxdWFudGl0eSk7XG4gIH0pKTtcblxuICByZXR1cm4ge1xuICAgIGlkOiBzYWxlSWQsXG4gICAgaXRlbXNTb2xkOiBpdGVtcyxcbiAgfTtcbn07XG5cbmNvbnN0IHVwZGF0ZSA9IGFzeW5jIChzYWxlSWQsIHVwZGF0ZWRJdGVtcykgPT4ge1xuICBjb25zdCBzYWxlID0gYXdhaXQgc2FsZXNNb2RlbC5nZXRCeUlkKHNhbGVJZCk7XG4gIGlmIChzYWxlLmxlbmd0aCA8PSAwKSB0aHJvdyBuZXcgTm90Rm91bmRFcnJvcihtZXNzYWdlcy5zYWxlLm5vdEZvdW5kKTtcblxuICBhd2FpdCBQcm9taXNlLmFsbCh1cGRhdGVkSXRlbXMubWFwKGFzeW5jICh1cGRhdGVkSXRlbSkgPT4ge1xuICAgIGNvbnN0IGlkS2V5ID0gJ3Byb2R1Y3RfaWQnOyAvLyBrZWVwIHNuYWtlX2Nhc2VcbiAgICBjb25zdCB7IFtpZEtleV06IHByb2R1Y3RJZCwgcXVhbnRpdHk6IG5ld1F1YW50aXR5IH0gPSB1cGRhdGVkSXRlbTtcbiAgICBhd2FpdCBzYWxlc01vZGVsLnVwZGF0ZShzYWxlSWQsIHByb2R1Y3RJZCwgbmV3UXVhbnRpdHkpO1xuICB9KSk7XG5cbiAgcmV0dXJuIHtcbiAgICBzYWxlSWQsXG4gICAgaXRlbVVwZGF0ZWQ6IHVwZGF0ZWRJdGVtcyxcbiAgfTtcbn07XG5cbmNvbnN0IHJlbW92ZSA9IGFzeW5jIChzYWxlSWQpID0+IHtcbiAgY29uc3Qgc2FsZSA9IGF3YWl0IHNhbGVzTW9kZWwuZ2V0QnlJZChzYWxlSWQpO1xuICBpZiAoc2FsZS5sZW5ndGggPD0gMCkgdGhyb3cgbmV3IE5vdEZvdW5kRXJyb3IobWVzc2FnZXMuc2FsZS5ub3RGb3VuZCk7XG5cbiAgYXdhaXQgc2FsZXNNb2RlbC5yZW1vdmUoc2FsZUlkKTtcblxuICByZXR1cm4gc2FsZTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBnZXRBbGwsXG4gIGdldEJ5SWQsXG4gIHZhbGlkYXRlU2FsZSxcbiAgY3JlYXRlLFxuICB1cGRhdGUsXG4gIHJlbW92ZSxcbn07Il19